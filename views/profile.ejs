<% layout('/layouts/boilerplate.ejs') -%>

 

<div class="container-xl py-3">
  <!-- Profile Header -->
  <div class="card shadow-sm mb-4">
    <div class="card-body p-4">
      <div class="row align-items-center">
      <div class="col-md-3 text-center">
        <div class="position-relative d-inline-block mb-3">
          <% if (user.profilePicture && user.profilePicture.path) { %>
            <img src="<%= user.profilePicture.path %>" alt="Profile Picture" id="profilePicture" class="rounded-circle border border-4 border-white shadow cursor-pointer" style="width:150px;height:150px;object-fit:cover;">
          <% } else { %>
            <div class="default-avatar rounded-circle bg-primary bg-gradient text-white d-flex align-items-center justify-content-center fw-bold shadow border border-4 border-white cursor-pointer" id="profilePicture" style="width:150px;height:150px;font-size:60px;">
              <%= user.username.charAt(0).toUpperCase() %>
            </div>
          <% } %>
          <button class="btn btn-primary rounded-circle position-absolute bottom-0 end-0 shadow d-flex align-items-center justify-content-center p-0" style="width:40px;height:40px;" onclick="document.getElementById('profilePictureInput').click()">
            <i class="fas fa-camera"></i>
          </button>
          <input type="file" id="profilePictureInput" class="d-none" accept="image/*">
        </div>
      </div>
      
      <div class="col-md-9">
        <div class="text-center">
          <h1 class="fs-3 fw-bold text-dark mb-2"><%= user.username %></h1>
          <p class="text-muted mb-3"><%= user.bio || "No bio yet" %></p>
          
          <!-- Stats -->
          <div class="d-flex justify-content-around my-3 py-3 border-top border-bottom">
            <div class="text-center" role="button" onclick="viewPosts()">
              <div class="fs-4 fw-bold text-dark" id="postsCount"><%= posts.length %></div>
              <div class="small text-muted mt-1">Posts</div>
            </div>
            <div class="text-center" role="button" onclick="viewFollowers()">
              <div class="fs-4 fw-bold text-dark" id="followersCount"><%= user.followers ? user.followers.length : 0 %></div>
              <div class="small text-muted mt-1">Followers</div>
            </div>
            <div class="text-center" role="button" onclick="viewFollowing()">
              <div class="fs-4 fw-bold text-dark" id="followingCount"><%= user.following ? user.following.length : 0 %></div>
              <div class="small text-muted mt-1">Following</div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- Posts Section -->
  <div class="posts-section">
    <h3 class="mb-4">Recent Posts</h3>
    
    <% if (posts && posts.length > 0) { %>
      <div class="row g-3 row-cols-1 row-cols-sm-2 row-cols-lg-3">
        <% posts.forEach(post => { %>
          <div class="col">
            <div class="card h-100 shadow-sm cursor-pointer" onclick="viewPost('<%= post._id %>')">
            <!-- Post Media -->
            <% if (post.media && post.media.length > 0) { %>
              <% if (post.media[0].isVideo) { %>
                <div class="ratio ratio-16x9">
                  <video class="w-100 h-100" muted style="object-fit: cover;">
                    <source src="<%= post.media[0].path %>" type="<%= post.media[0].mimetype %>">
                  </video>
                </div>
              <% } else { %>
                <div class="ratio ratio-16x9">
                  <img src="<%= post.media[0].path %>" alt="Post Image" class="w-100 h-100" style="object-fit: cover;">
                </div>
              <% } %>
            <% } else if (post.image && post.image.trim() !== '') { %>
              <div class="ratio ratio-16x9">
                <img src="<%= post.image %>" alt="Post Image" class="w-100 h-100" style="object-fit: cover;">
              </div>
            <% } else { %>
              <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center">
                <i class="fas fa-image fs-1 text-secondary"></i>
              </div>
            <% } %>
            
            <!-- Post Content -->
            <div class="card-body">
              <div class="h6 mb-2 text-dark fw-bold"><%= post.title %></div>
              <div class="text-muted small mb-2"><%= post.content %></div>
              <div class="d-flex justify-content-between align-items-center small text-muted">
                <span><%= post.createdAt.toLocaleDateString() %></span>
                <div class="d-flex align-items-center gap-3">
                  <span><i class="fas fa-heart"></i> <%= post.likes %></span>
                  <span><i class="fas fa-comment"></i> <%= post.comments ? post.comments.length : 0 %></span>
                </div>
              </div>
            </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="text-center py-5 text-muted">
        <i class="fas fa-camera fs-1 text-secondary mb-3"></i>
        <h4>No posts yet</h4>
        <p>Share your first post to get started!</p>
        <a href="/posts/new" class="btn btn-primary">Create Post</a>
      </div>
    <% } %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Profile picture upload functionality
  const profilePictureInput = document.getElementById('profilePictureInput');
  const profilePicture = document.getElementById('profilePicture');

  profilePictureInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file.');
      return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB.');
      return;
    }

    // Upload profile picture
    const formData = new FormData();
    formData.append('profilePicture', file);

    fetch('/profile/picture', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update profile picture display
        if (data.profilePicture) {
          profilePicture.src = data.profilePicture;
          profilePicture.style.display = 'block';
          // Hide default avatar if it exists
          if (profilePicture.classList.contains('default-avatar')) {
            profilePicture.classList.remove('default-avatar');
            profilePicture.style.background = 'none';
            profilePicture.innerHTML = '';
          }
        } else {
          // Show default avatar
          location.reload(); // Simple way to refresh the page
        }
      } else {
        alert('Error updating profile picture.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating profile picture.');
    });
  });

  // Add click to remove functionality (double click)
  let clickCount = 0;
  profilePicture.addEventListener('click', function() {
    clickCount++;
    setTimeout(() => {
      if (clickCount === 2) {
        // Double click to remove profile picture
        if (confirm('Remove profile picture?')) {
          fetch('/profile/picture', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            }
          });
        }
      }
      clickCount = 0;
    }, 300);
  });
});

function viewPosts() {
  // Scroll to posts section
  document.querySelector('.posts-section').scrollIntoView({ behavior: 'smooth' });
}

function viewFollowers() {
  // TODO: Implement followers modal/page
  alert('Followers list coming soon!');
}

function viewFollowing() {
  // TODO: Implement following modal/page
  alert('Following list coming soon!');
}

function viewPost(postId) {
  window.location.href = `/posts/${postId}`;
}
</script>


