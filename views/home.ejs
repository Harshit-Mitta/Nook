<% layout('/layouts/boilerplate.ejs') -%>

  <% if (posts && posts.length > 0) { %>
    <% posts.forEach(post => { %>
      <div class="post-card">
        <div class="post-header">
          <div class="d-flex align-items-center">
            <div class="profile-pic me-3" style="width: 40px; height: 40px; font-size: 16px;">
              <i class="fas fa-user"></i>
            </div>
            <div>
              <h6 class="mb-0">@<%= post.author %></h6>
              <small class="text-muted"><%= post.createdAt.toLocaleDateString() %></small>
            </div>
          </div>
        </div>
        
        <% if (post.image && post.image.trim() !== '') { %>
          <img src="<%= post.image %>" class="post-image" alt="Post image">
        <% } %>
        
        <div class="post-content">
          <h5 class="card-title"><%= post.title %></h5>
          <p class="card-text"><%= post.content %></p>
        </div>
        
        <div class="post-actions">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <button class="btn btn-link text-danger p-0 me-3 like-btn" data-post-id="<%= post._id %>">
                <i class="fas fa-heart"></i>
                <span class="ms-1 like-count"><%= post.likes %></span>
              </button>
              <button class="btn btn-link text-dark p-0 me-3">
                <!-- <i class="fas fa-comment"></i> -->
                <a href="/posts/<%= post._id %>" class="fas fa-comment"></a>
              </button>
              <button class="btn btn-link text-dark p-0 share-btn" data-post-id="<%= post._id %>" data-post-title="<%= post.title %>">
                <i class="fas fa-share"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  <% } else { %>
    <div class="text-center py-5">
      <h3>Welcome to Nook!</h3>
      <p class="text-muted">No posts yet. <a href="/posts/new">Create your first post</a></p>
    </div>
  <% } %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Like button functionality
  document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', async function() {
      const postId = this.dataset.postId;
      const likeCountSpan = this.querySelector('.like-count');
      
      try {
        const response = await fetch(`/posts/${postId}/like`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          likeCountSpan.textContent = data.likes;
          
          // Add animation effect
          this.style.transform = 'scale(1.2)';
          setTimeout(() => {
            this.style.transform = 'scale(1)';
          }, 200);
        }
      } catch (error) {
        console.error('Error liking post:', error);
      }
    });
  });

  // Share button functionality
  document.querySelectorAll('.share-btn').forEach(button => {
    button.addEventListener('click', function() {
      const postId = this.dataset.postId;
      const postTitle = this.dataset.postTitle;
      const postUrl = `${window.location.origin}/posts/${postId}`;
      
      // Create share modal
      const shareModal = document.createElement('div');
      shareModal.className = 'modal fade';
      shareModal.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Share Post</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p><strong>${postTitle}</strong></p>
              <div class="input-group mb-3">
                <input type="text" class="form-control" value="${postUrl}" id="postUrl" readonly>
                <button class="btn btn-outline-secondary" type="button" id="copyBtn">Copy</button>
              </div>
              <div class="d-flex gap-2 flex-wrap">
                <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(postTitle)}&url=${encodeURIComponent(postUrl)}" 
                   target="_blank" class="btn btn-primary btn-sm">
                  <i class="fab fa-twitter"></i> Twitter
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postUrl)}" 
                   target="_blank" class="btn btn-primary btn-sm">
                  <i class="fab fa-facebook"></i> Facebook
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(postUrl)}" 
                   target="_blank" class="btn btn-primary btn-sm">
                  <i class="fab fa-linkedin"></i> LinkedIn
                </a>
                <a href="https://wa.me/?text=${encodeURIComponent(postTitle + ' ' + postUrl)}" 
                   target="_blank" class="btn btn-success btn-sm">
                  <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(shareModal);
      
      // Initialize Bootstrap modal
      const modal = new bootstrap.Modal(shareModal);
      modal.show();
      
      // Copy to clipboard functionality
      document.getElementById('copyBtn').addEventListener('click', function() {
        const urlInput = document.getElementById('postUrl');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999); // For mobile devices
        
        navigator.clipboard.writeText(urlInput.value).then(function() {
          const copyBtn = document.getElementById('copyBtn');
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          copyBtn.className = 'btn btn-success';
          
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.className = 'btn btn-outline-secondary';
          }, 2000);
        });
      });
      
      // Clean up modal when closed
      shareModal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(shareModal);
      });
    });
  });
});
</script>

