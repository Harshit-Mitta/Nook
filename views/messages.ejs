<% layout('/layouts/boilerplate.ejs') -%>

<div class="chat-page">
  <!-- Search Bar (Full width above both sections) -->
  <div class="search-bar">
    <form action="/messages/search" method="GET">
      <input 
        type="text" 
        name="q" 
        placeholder="Search user..." 
        value="<%= typeof query !== 'undefined' ? query : '' %>" 
        required
      />
      <button type="submit">üîç</button>
    </form>
  </div>
 <% if (searchResults && searchResults.length > 0) { %>
  <div class="search-results">
    <h3>Search Results:</h3>
    <% searchResults.forEach(user => { %>
      <div class="search-result-item">
        <a href="/messages/chat/<%= user._id %>">
          <%= user.username %>
        </a>
      </div>
    <% }) %>
  </div>
<% } else if (typeof query !== 'undefined' && searchResults.length === 0) { %>
  <div class="no-results">
    <p>No users found for "<%= query %>".</p>
  </div>
<% } %>



  <!-- Main Chat Container -->
  <div class="chat-container">

    <!-- LEFT SIDEBAR -->
    <div class="chat-sidebar">
      <div class="chat-list">
        <% if (messages.length === 0) { %>
          <p class="empty-text">No chats yet.<br>Search someone to start chatting!</p>
        <% } else { %>
          <% messages.forEach(msg => { %>
            <div class="chat-item" 
              onclick="window.location.href='/messages/chat/<%= msg.sender && msg.sender._id === user._id ? msg.receiver._id : msg.sender._id %>'">
              <div class="chat-info">
                <strong>
                  <%= msg.sender && msg.sender.name === user.name 
                      ? msg.receiver ? msg.receiver.name : "Unknown" 
                      : msg.sender ? msg.sender.name : "Unknown" %>
                </strong>
                <p><%= msg.body.slice(0, 30) %>...</p>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <!-- RIGHT CHAT WINDOW -->
    <div class="chat-window">
      <% if (chatUser) { %>
        <div class="chat-header">
          <h2>Chat with <%= chatUser.name %></h2>
        </div>

        <div class="chat-body">
          <% if (chatMessages.length > 0) { %>
            <% chatMessages.forEach(msg => { %>
              <div class="msg <%= msg.sender._id === user._id ? 'sent' : 'received' %>">
                <%= msg.body %>
              </div>
            <% }) %>
          <% } else { %>
            <p class="empty-text">No messages yet. Start the conversation!</p>
          <% } %>
        </div>

        <form class="chat-input" action="/messages/send/<%= chatUser._id %>" method="POST">
          <input type="text" name="body" placeholder="Type a message..." required />
          <button type="submit">Send</button>
        </form>
      <% } else { %>
        <div class="chat-empty">
          <p>Select or search a user to start messaging</p>
        </div>
      <% } %>
    </div>
  </div>
</div>

<style>
/* ===== PAGE WRAPPER ===== */
.chat-page {
  width: 90%;
  margin: 2rem auto;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ===== SEARCH BAR ===== */
.search-bar {
  background: #f9f9f9;
  border-bottom: 1px solid #ddd;
  padding: 15px 20px;
  display: flex;
  justify-content: center;
}

.search-bar form {
  display: flex;
  width: 100%;
  max-width: 500px;
  align-items: center;
  gap: 10px;
}

.search-bar input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid #ccc;
  border-radius: 25px;
  font-size: 15px;
  outline: none;
}

.search-bar button {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}

.search-bar button:hover {
  background: #0056b3;
}

/* ===== CHAT CONTAINER ===== */
.chat-container {
  display: flex;
  height: 80vh;
}

/* ===== SIDEBAR ===== */
.chat-sidebar {
  width: 30%;
  background: #f8f9fa;
  border-right: 1px solid #ddd;
  display: flex;
  flex-direction: column;
}

.chat-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.chat-item {
  background: #fff;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  transition: background 0.3s;
  cursor: pointer;
}

.chat-item:hover {
  background: #e9e9e9;
}

.chat-info strong {
  display: block;
  font-size: 15px;
  color: #333;
}

.chat-info p {
  color: #666;
  font-size: 13px;
  margin-top: 4px;
}

.empty-text {
  text-align: center;
  color: #777;
  margin-top: 30px;
}

/* ===== CHAT WINDOW ===== */
.chat-window {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #fff;
}

.chat-header {
  background: #f1f1f1;
  padding: 15px;
  border-bottom: 1px solid #ddd;
  text-align: center;
}

.chat-header h2 {
  margin: 0;
  color: #333;
  font-size: 18px;
}

.chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #f9f9f9;
}

.msg {
  max-width: 70%;
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 10px;
  word-wrap: break-word;
}

.msg.sent {
  background: #007bff;
  color: white;
  margin-left: auto;
  text-align: right;
}

.msg.received {
  background: #e9e9e9;
  color: #333;
  text-align: left;
}

.chat-input {
  display: flex;
  padding: 12px;
  background: #f1f1f1;
  border-top: 1px solid #ddd;
}

.chat-input input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #ccc;
}

.chat-input button {
  margin-left: 10px;
  padding: 10px 16px;
  border: none;
  border-radius: 20px;
  background: #007bff;
  color: white;
  cursor: pointer;
  transition: 0.3s;
}

.chat-input button:hover {
  background: #0056b3;
}

.chat-empty {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #777;
  font-size: 15px;
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
  .chat-container {
    flex-direction: column;
    height: auto;
  }
  .chat-sidebar {
    width: 100%;
  }
  .chat-window {
    width: 100%;
    min-height: 60vh;
  }
}
.search-results {
  background: #fdfdfd;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px 15px;
  margin: 15px auto;
  width: 85%;
}

.search-results h3 {
  margin-bottom: 8px;
  color: #333;
  font-size: 16px;
}

.search-results ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.search-results li {
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}

.search-results li a {
  color: #007bff;
  text-decoration: none;
  font-weight: 500;
}

.search-results li a:hover {
  text-decoration: underline;
}

</style>
